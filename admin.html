<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Baby Raffle</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6">Baby Raffle Admin Dashboard</h1>
        
        <div id="login-section" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Admin Login</h2>
            <input type="password" id="admin-password" placeholder="Enter password" 
                   class="w-full p-2 border rounded mb-4" onkeypress="handleKeyPress(event)">
            <button onclick="login()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                Login
            </button>
            <div id="login-error" class="text-red-500 mt-2 hidden">Invalid password</div>
        </div>

        <div id="admin-content" class="hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Submitted Bets</h2>
                <button onclick="loadBets()" class="mb-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Refresh Data
                </button>
                <div id="bets-container">
                    <div class="text-gray-500">Loading bets...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://margojones-production.up.railway.app';
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                login();
            }
        }
        
        function login() {
            const password = document.getElementById('admin-password').value;
            const loginError = document.getElementById('login-error');
            
            if (password === 'admin123') {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                loadBets();
                loginError.classList.add('hidden');
            } else {
                loginError.classList.remove('hidden');
            }
        }
        
        async function loadBets() {
            const container = document.getElementById('bets-container');
            container.innerHTML = '<div class="text-gray-500">Loading bets...</div>';
            
            try {
                const response = await fetch(`${API_URL}/admin/bets`);
                const bets = await response.json();
                
                if (bets.length === 0) {
                    container.innerHTML = '<div class="text-gray-500">No bets submitted yet.</div>';
                    return;
                }
                
                let html = `
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-2 text-left">ID</th>
                                    <th class="px-4 py-2 text-left">Name</th>
                                    <th class="px-4 py-2 text-left">Email</th>
                                    <th class="px-4 py-2 text-left">Category</th>
                                    <th class="px-4 py-2 text-left">Bet</th>
                                    <th class="px-4 py-2 text-left">Amount</th>
                                    <th class="px-4 py-2 text-left">Date</th>
                                    <th class="px-4 py-2 text-left">Status</th>
                                    <th class="px-4 py-2 text-left">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                bets.forEach(bet => {
                    const isValidated = bet.validated || false;
                    const statusBadge = isValidated 
                        ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Authenticated</span>'
                        : '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">Pending</span>';
                    
                    const authenticateButton = isValidated 
                        ? '<span class="text-gray-500 text-sm">Validated</span>'
                        : `<button onclick="authenticateBet(${bet.id})" 
                             class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 disabled:opacity-50 mr-1" 
                             id="auth-btn-${bet.id}">Authenticate</button>`;
                    
                    const deleteButton = `<button onclick="deleteBet(${bet.id})" 
                        class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 disabled:opacity-50" 
                        id="del-btn-${bet.id}">Delete</button>`;
                    
                    const actionButton = authenticateButton + deleteButton;
                    
                    html += `
                        <tr class="border-b ${isValidated ? 'bg-green-50' : ''}">
                            <td class="px-4 py-2">${bet.id}</td>
                            <td class="px-4 py-2">${bet.name}</td>
                            <td class="px-4 py-2">${bet.email}</td>
                            <td class="px-4 py-2">${bet.categoryKey}</td>
                            <td class="px-4 py-2">${bet.betValue}</td>
                            <td class="px-4 py-2">$${bet.amount}</td>
                            <td class="px-4 py-2">${new Date(bet.created_at).toLocaleString()}</td>
                            <td class="px-4 py-2">${statusBadge}</td>
                            <td class="px-4 py-2">${actionButton}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                html += `<div class="mt-4 text-gray-600">Total: ${bets.length} bets</div>`;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading bets:', error);
                container.innerHTML = '<div class="text-red-500">Error loading bets. Check console for details.</div>';
            }
        }
        
        async function authenticateBet(betId) {
            const button = document.getElementById(`auth-btn-${betId}`);
            const originalText = button.textContent;
            
            // Disable button and show loading
            button.disabled = true;
            button.textContent = 'Authenticating...';
            button.classList.add('opacity-50');
            
            try {
                // For now, just simulate authentication by marking as validated
                // In a real system, you'd call a backend API to validate the bet
                const response = await fetch(`${API_URL}/admin/validate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        betIds: [betId],
                        validatedBy: 'admin'
                    })
                });
                
                if (response.ok) {
                    // Show success message
                    showMessage('Bet authenticated successfully!', 'success');
                    // Reload the bets to show updated status
                    setTimeout(() => {
                        loadBets();
                    }, 1000);
                } else {
                    throw new Error('Failed to authenticate bet');
                }
                
            } catch (error) {
                console.error('Error authenticating bet:', error);
                showMessage('Failed to authenticate bet. This feature may not be implemented in the backend yet.', 'error');
                
                // Re-enable button
                button.disabled = false;
                button.textContent = originalText;
                button.classList.remove('opacity-50');
            }
        }
        
        async function deleteBet(betId) {
            // Confirm deletion
            if (!confirm('Are you sure you want to delete this bet? This action cannot be undone.')) {
                return;
            }
            
            const button = document.getElementById(`del-btn-${betId}`);
            const originalText = button.textContent;
            
            // Disable button and show loading
            button.disabled = true;
            button.textContent = 'Deleting...';
            button.classList.add('opacity-50');
            
            try {
                const response = await fetch(`${API_URL}/admin/bets/${betId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('Bet deleted successfully!', 'success');
                    // Reload the bets to show updated list
                    setTimeout(() => {
                        loadBets();
                    }, 500);
                } else {
                    throw new Error('Failed to delete bet');
                }
                
            } catch (error) {
                console.error('Error deleting bet:', error);
                showMessage('Failed to delete bet. Check console for details.', 'error');
                
                // Re-enable button
                button.disabled = false;
                button.textContent = originalText;
                button.classList.remove('opacity-50');
            }
        }
        
        function showMessage(message, type) {
            // Create and show a temporary message
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 p-4 rounded shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // Remove message after 3 seconds
            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 3000);
        }
    </script>
</body>
</html>